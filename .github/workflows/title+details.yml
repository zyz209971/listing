name: æ™ºèƒ½æå–å±æ€§ç”Ÿæˆæ ‡é¢˜

on:
  workflow_dispatch:
    inputs:
      url:
        description: '1688å•†å“ç½‘å€'
        required: true
        default: 'https://detail.1688.com/offer/'

jobs:
  extract-and-create:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. æŠ“å–å•†å“é¡µé¢
        run: |
          echo "å¼€å§‹æŠ“å–: ${{ github.event.inputs.url }}"
          curl -s "${{ github.event.inputs.url }}" -o product_page.html
          
      - name: 2. æå–å±æ€§å¹¶ç”Ÿæˆæ ‡é¢˜
        run: |
          pip install googletrans beautifulsoup4
          
          python << 'EOF'
import requests
from bs4 import BeautifulSoup
from googletrans import Translator
import re
import json

# è¯»å–é¡µé¢
with open('product_page.html', 'r', encoding='utf-8') as f:
    soup = BeautifulSoup(f, 'html.parser')

# æŸ¥æ‰¾å±æ€§è¡¨
specs = {}
tables = soup.find_all('table')
for table in tables:
    rows = table.find_all('tr')
    for row in rows:
        cells = row.find_all(['td', 'th'])
        if len(cells) >= 2:
            key = cells[0].get_text(strip=True)
            value = cells[1].get_text(strip=True) if len(cells) > 1 else ''
            if key and value:
                specs[key] = value

# å…³é”®è¯æ˜ å°„ï¼ˆåŒ…å«æœºèŠ¯å“ç‰Œï¼‰
keyword_map = {
    # æœºèŠ¯ç±»å‹
    'çŸ³è‹±': 'Quartz', 
    'è‡ªåŠ¨æœºæ¢°': 'Automatic', 
    'æœºæ¢°': 'Mechanical',
    'å¤ªé˜³èƒ½': 'Solar',
    
    # æè´¨
    'ä¸é”ˆé’¢': 'Stainless Steel', 
    'é’›åˆé‡‘': 'Titanium',
    'é™¶ç“·': 'Ceramic',
    'çš®è´¨': 'Leather',
    
    # åŠŸèƒ½
    'é˜²æ°´': 'Water Resistant', 
    'å¤œå…‰': 'Luminous', 
    'è“å®çŸ³': 'Sapphire',
    'æ—¥å†': 'Calendar',
    'è®¡æ—¶': 'Chronograph',
    
    # é£æ ¼
    'ç”·å£«': "Men's",
    'å¥³å£«': "Women's", 
    'å•†åŠ¡': 'Business', 
    'è¿åŠ¨': 'Sports',
    'ä¼‘é—²': 'Casual',
    
    # æœºèŠ¯å“ç‰Œ
    'miyota': 'Miyota',
    'è¥¿é“åŸ': 'Citizen',
    'ç²¾å·¥': 'Seiko',
    'eta': 'ETA',
    'ronda': 'Ronda',
    'å¤©é©¬æ¸¡': 'Tianmadu',
    'æ­å·': 'Hangzhou',
    
    # å“ç‰Œå…³é”®è¯ï¼ˆç”¨äºè¿‡æ»¤ï¼‰
    'å“ç‰Œ': 'brand',
    'å‚å®¶': 'factory',
    'å•†æ ‡': 'trademark',
}

# æå–æ‰€æœ‰æ–‡æœ¬
all_text = ' '.join(specs.keys()) + ' ' + ' '.join(specs.values())
all_text_lower = all_text.lower()

# æå–å…³é”®è¯
keywords = []
movement_brand = None

# å…ˆæå–æœºèŠ¯å“ç‰Œ
movement_brands = {
    'miyota': 'Miyota',
    'citizen': 'Citizen', 
    'seiko': 'Seiko',
    'eta': 'ETA',
    'ronda': 'Ronda',
    'ç²¾å·¥': 'Seiko',
    'è¥¿é“åŸ': 'Citizen',
    'å¤©é©¬æ¸¡': 'Tianmadu',
}

for brand_key, brand_en in movement_brands.items():
    if brand_key in all_text_lower:
        movement_brand = brand_en
        break

# æå–å…¶ä»–å…³é”®è¯
for cn, en in keyword_map.items():
    if cn.lower() in all_text_lower and en not in ['brand', 'factory', 'trademark']:
        keywords.append(en)

# ç”Ÿæˆæ ‡é¢˜
title_parts = []

# 1. æè´¨
material_keywords = ['Stainless Steel', 'Titanium', 'Ceramic', 'Leather']
for mat in material_keywords:
    if mat in keywords:
        title_parts.append(mat)
        break

# 2. æœºèŠ¯ç±»å‹
movement_found = False
movement_keywords = ['Quartz', 'Automatic', 'Mechanical', 'Solar']
for move in movement_keywords:
    if move in keywords:
        title_parts.append(move)
        movement_found = True
        break

if not movement_found:
    title_parts.append('Watch')
else:
    title_parts.append('Watch')

# 3. æœºèŠ¯å“ç‰Œ
if movement_brand:
    title_parts.append(f'with {movement_brand} Movement')

# 4. é£æ ¼
style_keywords = ['Business', 'Sports', 'Casual']
for style in style_keywords:
    if style in keywords:
        title_parts.append(f'{style} Style')
        break

# 5. åŠŸèƒ½
feature_keywords = ['Water Resistant', 'Luminous', 'Sapphire', 'Calendar', 'Chronograph']
features = [f for f in feature_keywords if f in keywords]
if features:
    if len(features) > 1:
        title_parts.append(f'with {features[0]} and {features[1]}')
    else:
        title_parts.append(f'with {features[0]}')

# 6. æ€§åˆ«
if "Men's" in keywords:
    title_parts.append("Men's")
elif "Women's" in keywords:
    title_parts.append("Women's")

# ç»„åˆæ ‡é¢˜
english_title = ' '.join(title_parts)

# ä¿å­˜ç»“æœ
result = {
    'title': english_title,
    'movement_brand': movement_brand,
    'specs_count': len(specs),
    'keywords': keywords,
    'title_parts': title_parts
}

with open('result.json', 'w', encoding='utf-8') as f:
    json.dump(result, f, ensure_ascii=False, indent=2)

print(f"âœ… ç”Ÿæˆæ ‡é¢˜: {english_title}")
print(f"ğŸ”§ æœºèŠ¯å“ç‰Œ: {movement_brand or 'æœªè¯†åˆ«'}")
print(f"ğŸ“Š å±æ€§æ•°é‡: {len(specs)}")
print(f"ğŸ”‘ å…³é”®è¯: {', '.join(keywords)}")
EOF
          
      - name: 3. æ˜¾ç¤ºç»“æœ
        run: |
          echo "===== ç”Ÿæˆç»“æœ ====="
          if [ -f "result.json" ]; then
            python << 'EOF'
import json
with open('result.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
print(f"æ ‡é¢˜: {data['title']}")
print(f"æœºèŠ¯å“ç‰Œ: {data.get('movement_brand', 'æ— ')}")
print(f"å±æ€§æ•°é‡: {data['specs_count']}")
EOF
          else
            echo "æœªæ‰¾åˆ°ç»“æœæ–‡ä»¶"
          fi
          
      - name: 4. ä¿å­˜ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ç»“æœ
          path: |
            result.json
