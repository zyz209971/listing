name: æ™ºèƒ½æå–å±æ€§ç”Ÿæˆæ ‡é¢˜

on:
  workflow_dispatch:
    inputs:
      url:
        description: '1688å•†å“ç½‘å€'
        required: true
        default: 'https://detail.1688.com/offer/'

jobs:
  extract-and-create:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. æŠ“å–å•†å“é¡µé¢
        run: |
          echo "å¼€å§‹æŠ“å–: ${{ github.event.inputs.url }}"
          curl -s "${{ github.event.inputs.url }}" -o product_page.html
          echo "é¡µé¢å·²ä¿å­˜"
          
      - name: 2. æå–å±æ€§å¹¶ç”Ÿæˆæ ‡é¢˜
        run: |
          echo "å®‰è£…å¿…è¦å·¥å…·..."
          pip install googletrans==4.0.0-rc1 beautifulsoup4
          
          python << 'EOF'
          from bs4 import BeautifulSoup
          from googletrans import Translator
          import re
          import json
          
          translator = Translator()
          
          # è¯»å–é¡µé¢
          with open('product_page.html', 'r', encoding='utf-8') as f:
              soup = BeautifulSoup(f, 'html.parser')
          
          print("ğŸ”„ å¼€å§‹æå–å•†å“å±æ€§...")
          
          # 1. æŸ¥æ‰¾å±æ€§è¡¨æ ¼
          def find_spec_table(soup):
              """æŸ¥æ‰¾å•†å“è§„æ ¼å‚æ•°è¡¨"""
              table_selectors = [
                  'table.params', 'table.spec-table', '.offer-params',
                  '.detail-table', 'table[class*="param"]', 'table[class*="spec"]',
                  '.sku-attr', '.props-table'
              ]
              
              for selector in table_selectors:
                  table = soup.select_one(selector)
                  if table:
                      return table
              
              # å¤‡ç”¨ï¼šæŸ¥æ‰¾æ‰€æœ‰è¡¨æ ¼
              tables = soup.find_all('table')
              for table in tables:
                  if len(table.find_all('tr')) >= 2:
                      return table
              
              return None
          
          # 2. æå–å±æ€§é”®å€¼å¯¹
          def extract_specifications(table):
              """ä»è¡¨æ ¼æå–è§„æ ¼å‚æ•°"""
              specs = {}
              
              if not table:
                  return specs
              
              rows = table.find_all('tr')
              for row in rows:
                  cells = row.find_all(['td', 'th'])
                  if len(cells) >= 2:
                      key = cells[0].get_text(strip=True)
                      value = cells[1].get_text(strip=True) if len(cells) > 1 else ''
                      
                      if key and value and len(key) < 50:
                          specs[key] = value
              
              return specs
          
          # 3. æ™ºèƒ½æ¸…æ´—å’Œåˆ†ç±»å±æ€§
          def clean_and_categorize_specs(specs):
              """æ¸…æ´—å±æ€§å¹¶åˆ†ç±»"""
              # éœ€è¦ç§»é™¤çš„å“ç‰Œå…³é”®è¯
              brand_keywords = [
                  'å“ç‰Œ', 'å•†æ ‡', 'å‚å®¶', 'åˆ¶é€ å•†', 'ç”Ÿäº§å•†', 
                  'å…¬å¸', 'å‚å', 'äº§åœ°', 'ç”Ÿäº§å‚å®¶'
              ]
              
              # éœ€è¦ä¿ç•™çš„æœºèŠ¯å“ç‰Œ
              movement_brands = ['miyota', 'seiko', 'eta', 'ronda', 'citizen', 'ç²¾å·¥', 'è¥¿é“åŸ']
              
              cleaned_specs = {}
              important_attributes = []
              
              for key, value in specs.items():
                  key_lower = key.lower()
                  value_lower = value.lower()
                  
                  # æ£€æŸ¥æ˜¯å¦æ˜¯å“ç‰Œä¿¡æ¯
                  is_brand_info = False
                  for brand_kw in brand_keywords:
                      if brand_kw in key_lower:
                          is_brand_info = True
                          break
                  
                  # å¦‚æœæ˜¯å“ç‰Œä¿¡æ¯ä½†ä¸æ˜¯æœºèŠ¯å“ç‰Œï¼Œè·³è¿‡
                  if is_brand_info:
                      is_movement_brand = False
                      for movement in movement_brands:
                          if movement in value_lower:
                              is_movement_brand = True
                              break
                      
                      if not is_movement_brand:
                          continue
                  
                  # æ¸…ç†åçš„å±æ€§
                  cleaned_specs[key] = value
                  
                  # è¯†åˆ«é‡è¦å±æ€§ç”¨äºæ ‡é¢˜
                  if any(kw in key_lower for kw in ['æœºèŠ¯', 'ç±»å‹', 'æè´¨', 'é£æ ¼', 'åŠŸèƒ½', 'é˜²æ°´', 'è¡¨å¸¦', 'è¡¨é•œ']):
                      important_attributes.append(f"{key}:{value}")
                  elif 'é˜²æ°´' in value_lower or 'å¤œå…‰' in value_lower or 'è“å®çŸ³' in value_lower:
                      important_attributes.append(f"{key}:{value}")
              
              return cleaned_specs, important_attributes
          
          # 4. ä»å±æ€§ç”Ÿæˆæ ‡é¢˜å…³é”®è¯
          def extract_title_keywords(attributes, specs):
              """ä»å±æ€§æå–æ ‡é¢˜å…³é”®è¯"""
              # å…³é”®è¯æ˜ å°„è¡¨
              keyword_map = {
                  # æœºèŠ¯ç±»å‹
                  'çŸ³è‹±': 'Quartz',
                  'è‡ªåŠ¨æœºæ¢°': 'Automatic Mechanical',
                  'æœºæ¢°': 'Mechanical',
                  'å¤ªé˜³èƒ½': 'Solar',
                  'ç”µå­': 'Digital',
                  'å…‰åŠ¨èƒ½': 'Eco-Drive',
                  
                  # æè´¨
                  'ä¸é”ˆé’¢': 'Stainless Steel',
                  'é’›åˆé‡‘': 'Titanium',
                  'é™¶ç“·': 'Ceramic',
                  'é’¨é’¢': 'Tungsten Steel',
                  'å¡‘æ–™': 'Plastic',
                  'æ©¡èƒ¶': 'Rubber',
                  'å°¼é¾™': 'Nylon',
                  'çš®è´¨': 'Leather',
                  'çœŸçš®': 'Genuine Leather',
                  'é‡‘å±': 'Metal',
                  'åˆé‡‘': 'Alloy',
                  
                  # åŠŸèƒ½
                  'é˜²æ°´': 'Water Resistant',
                  'å¤œå…‰': 'Luminous',
                  'æ—¥å†': 'Calendar',
                  'æ˜ŸæœŸ': 'Week',
                  'è®¡æ—¶': 'Chronograph',
                  'é—¹é’Ÿ': 'Alarm',
                  'ä¸–ç•Œæ—¶': 'World Time',
                  'æ¸©åº¦': 'Temperature',
                  'æ°”å‹': 'Barometer',
                  'æŒ‡å—é’ˆ': 'Compass',
                  
                  # é£æ ¼
                  'å•†åŠ¡': 'Business',
                  'ä¼‘é—²': 'Casual',
                  'è¿åŠ¨': 'Sports',
                  'æ—¶å°š': 'Fashion',
                  'å¤å¤': 'Vintage',
                  'ç»å…¸': 'Classic',
                  'ç®€çº¦': 'Minimalist',
                  'å¥¢å': 'Luxury',
                  
                  # è¡¨é•œ
                  'è“å®çŸ³': 'Sapphire Crystal',
                  'çŸ¿ç‰©ç»ç’ƒ': 'Mineral Glass',
                  'äºšå…‹åŠ›': 'Acrylic',
                  
                  # æœºèŠ¯å“ç‰Œ
                  'miyota': 'Miyota',
                  'è¥¿é“åŸ': 'Citizen',
                  'ç²¾å·¥': 'Seiko',
                  'eta': 'ETA',
                  'ronda': 'Ronda',
              }
              
              all_text = ' '.join(attributes) + ' ' + ' '.join(specs.values())
              
              extracted_keywords = []
              for chinese, english in keyword_map.items():
                  if chinese.lower() in all_text.lower():
                      extracted_keywords.append(english)
              
              # å»é‡
              extracted_keywords = list(dict.fromkeys(extracted_keywords))
              
              return extracted_keywords
          
          # 5. æ™ºèƒ½ç»„åˆè‹±æ–‡æ ‡é¢˜
          def build_smart_title(keywords, specs):
              """ç”¨å…³é”®è¯æ™ºèƒ½ç»„åˆæ ‡é¢˜"""
              
              # åˆ†ç±»å…³é”®è¯
              movement_type = []
              material = []
              features = []
              style = []
              movement_brand = []
              
              movement_indicators = ['Quartz', 'Automatic', 'Mechanical', 'Solar', 'Digital']
              material_indicators = ['Steel', 'Titanium', 'Ceramic', 'Leather', 'Metal', 'Alloy']
              feature_indicators = ['Water', 'Luminous', 'Calendar', 'Chronograph', 'Alarm']
              style_indicators = ['Business', 'Casual', 'Sports', 'Fashion', 'Vintage']
              brand_indicators = ['Miyota', 'Citizen', 'Seiko', 'ETA', 'Ronda']
              
              for kw in keywords:
                  kw_lower = kw.lower()
                  if any(indicator.lower() in kw_lower for indicator in movement_indicators):
                      movement_type.append(kw)
                  elif any(indicator.lower() in kw_lower for indicator in material_indicators):
                      material.append(kw)
                  elif any(indicator.lower() in kw_lower for indicator in feature_indicators):
                      features.append(kw)
                  elif any(indicator.lower() in kw_lower for indicator in style_indicators):
                      style.append(kw)
                  elif any(indicator.lower() in kw_lower for indicator in brand_indicators):
                      movement_brand.append(kw)
              
              # æ„å»ºæ ‡é¢˜ç»“æ„
              title_parts = []
              
              # 1. æè´¨
              if material:
                  title_parts.append(material[0])
              
              # 2. æœºèŠ¯ç±»å‹
              if movement_type:
                  title_parts.append(movement_type[0])
              else:
                  title_parts.append("Watch")
              
              # 3. æœºèŠ¯å“ç‰Œ
              if movement_brand:
                  title_parts.append(f"with {movement_brand[0]} Movement")
              
              # 4. é£æ ¼
              if style:
                  title_parts.append(f"{style[0]} Style")
              
              # 5. åŠŸèƒ½
              if features:
                  features_str = ", ".join(features[:2])
                  title_parts.append(f"with {features_str}")
              
              # 6. æ€§åˆ«ï¼ˆä»å±æ€§åˆ¤æ–­ï¼‰
              gender = ""
              for value in specs.values():
                  if 'ç”·' in value:
                      gender = "Men's"
                      break
                  elif 'å¥³' in value:
                      gender = "Women's"
                      break
              
              if gender:
                  title_parts.append(gender)
              
              # ç»„åˆæ ‡é¢˜
              if not title_parts:
                  return "High Quality Watch"
              
              final_title = " ".join(title_parts)
              
              # ç¡®ä¿åŒ…å«Watch
              if 'watch' not in final_title.lower():
                  final_title += " Wristwatch"
              
              return final_title
          
          # 6. ç¿»è¯‘å±æ€§
          def translate_specifications(specs):
              """ç¿»è¯‘å±æ€§ä¸ºè‹±æ–‡"""
              translated = {}
              
              for key, value in list(specs.items())[:15]:  # åªç¿»è¯‘å‰15ä¸ª
                  try:
                      if re.search(r'[\\u4e00-\\u9fff]', key):  # åŒ…å«ä¸­æ–‡
                          trans_key = translator.translate(key, src='zh-cn', dest='en').text
                      else:
                          trans_key = key
                      
                      if re.search(r'[\\u4e00-\\u9fff]', value):  # åŒ…å«ä¸­æ–‡
                          trans_value = translator.translate(value, src='zh-cn', dest='en').text
                      else:
                          trans_value = value
                      
                      translated[trans_key] = trans_value
                  except:
                      translated[key] = value
              
              return translated
          
          # ä¸»å¤„ç†æµç¨‹
          print("=" * 60)
          
          # æŸ¥æ‰¾å±æ€§è¡¨
          spec_table = find_spec_table(soup)
          
          if not spec_table:
              print("âŒ æœªæ‰¾åˆ°å•†å“å±æ€§è¡¨ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•...")
              # å¤‡ç”¨ï¼šæŸ¥æ‰¾æ‰€æœ‰åŒ…å«è§„æ ¼çš„æ–‡æœ¬
              all_text = soup.get_text()
              specs = {}
              # ç®€å•æå–å…³é”®è¯
          else:
              # æå–å±æ€§
              raw_specs = extract_specifications(spec_table)
              print(f"ğŸ“‹ æ‰¾åˆ° {len(raw_specs)} ä¸ªå±æ€§")
              
              # æ¸…æ´—å’Œåˆ†ç±»
              cleaned_specs, important_attrs = clean_and_categorize_specs(raw_specs)
              print(f"ğŸ§¹ æ¸…æ´—åä¿ç•™ {len(cleaned_specs)} ä¸ªå±æ€§")
              
              if important_attrs:
                  print(f"ğŸ”‘ é‡è¦å±æ€§: {important_attrs}")
              
              # æå–å…³é”®è¯
              title_keywords = extract_title_keywords(important_attrs, cleaned_specs)
              print(f"ğŸ¯ æå–å…³é”®è¯: {title_keywords}")
              
              # ç”Ÿæˆæ ‡é¢˜
              english_title = build_smart_title(title_keywords, cleaned_specs)
              print(f"âœ¨ ç”Ÿæˆæ ‡é¢˜: {english_title}")
              
              # ç¿»è¯‘å±æ€§
              translated_specs = translate_specifications(cleaned_specs)
              
              # ä¿å­˜ç»“æœ
              result = {
                  'generated_title': english_title,
                  'original_specs_count': len(raw_specs),
                  'cleaned_specs_count': len(cleaned_specs),
                  'title_keywords': title_keywords,
                  'translated_specifications': translated_specs,
                  'important_attributes': important_attrs
              }
              
              with open('result.json', 'w', encoding='utf-8') as f:
                  json.dump(result, f, ensure_ascii=False, indent=2)
              
              # è¾“å‡ºæ‘˜è¦
              print("\\nâœ… å¤„ç†å®Œæˆï¼")
              print(f"   ç”Ÿæˆæ ‡é¢˜: {english_title}")
              print(f"   å…³é”®è¯æ•°é‡: {len(title_keywords)}")
              print(f"   ç¿»è¯‘å±æ€§: {len(translated_specs)} é¡¹")
              
              # æ˜¾ç¤ºå‰5ä¸ªç¿»è¯‘å±æ€§
              print("\\nğŸ“„ ç¿»è¯‘åå±æ€§ (ç¤ºä¾‹):")
              for i, (key, value) in enumerate(list(translated_specs.items())[:5]):
                  print(f"   {i+1}. {key}: {value}")
          
          EOF
          
      - name: 3. æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        run: |
          echo "ğŸ‰ æ™ºèƒ½æ ‡é¢˜ç”Ÿæˆå®Œæˆ"
          echo "======================"
          
          if [ -f "result.json" ]; then
            python << 'EOF'
            import json
            
            with open('result.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            print(f"ğŸ“Œ ç”Ÿæˆæ ‡é¢˜: {data.get('generated_title', 'æ— ')}")
            print(f"ğŸ”‘ ä½¿ç”¨å…³é”®è¯: {', '.join(data.get('title_keywords', []))}")
            print(f"ğŸ“Š å±æ€§æ•°é‡: {data.get('cleaned_specs_count', 0)} é¡¹")
            
            # æ˜¾ç¤ºå®Œæ•´æ ‡é¢˜
            print("\\nâœ¨ ä¼˜åŒ–åè‹±æ–‡æ ‡é¢˜:")
            print("-" * 50)
            print(data.get('generated_title', 'æ— '))
            print("-" * 50)
            
            # æ˜¾ç¤ºé‡è¦å±æ€§
            important = data.get('important_attributes', [])
            if important:
                print("\\nğŸ” é‡è¦åŸå§‹å±æ€§:")
                for attr in important[:5]:
                    print(f"   â€¢ {attr}")
            
            EOF
          else
            echo "âŒ æœªç”Ÿæˆç»“æœæ–‡ä»¶"
          fi
          
      - name: 4. ä¿å­˜ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: å±æ€§æå–ç»“æœ
          path: |
            result.json
            product_page.html
